ä½ é‡åˆ°çš„é—®é¢˜å…¶å®æ˜¯ DOM ç»“æ„å’Œé€‰æ‹©å™¨çš„é—®é¢˜ï¼šè™½ç„¶èƒ½æ‹¿åˆ° <table>ï¼Œä½†åœ¨ Confluence çš„é¡µé¢é‡Œï¼Œè¡¨æ ¼å¾€å¾€æœ‰åµŒå¥—çš„æ ·å¼æˆ–ç‰¹æ®Šçš„ classï¼Œå¯¼è‡´ç›´æ¥ç”¨ querySelectorAll("tr td") ä¸ç¨³å®šã€‚è¦ç²¾ç¡®è°ƒæ•´åˆ—å®½ï¼Œæ¨èç”¨ <colgroup> æ¥æ§åˆ¶ï¼Œè€Œä¸æ˜¯é€ä¸ª <td>ã€‚

---

âœ… æ¨èåšæ³•ï¼šä½¿ç”¨ `<colgroup>` æ§åˆ¶åˆ—å®½

function adjustTableColumns(table, mode = "average", fixedWidth = 150) {
  const firstRow = table.querySelector("tr");
  if (!firstRow) return;

  const cols = firstRow.querySelectorAll("td, th");
  const colCount = cols.length;
  if (colCount === 0) return;

  // å¦‚æœæ²¡æœ‰ colgroupï¼Œå…ˆåˆ›å»º
  let colgroup = table.querySelector("colgroup");
  if (!colgroup) {
    colgroup = document.createElement("colgroup");
    for (let i = 0; i < colCount; i++) {
      const col = document.createElement("col");
      colgroup.appendChild(col);
    }
    table.insertBefore(colgroup, table.firstChild);
  }

  // è®¾ç½®å®½åº¦
  const colElements = colgroup.querySelectorAll("col");
  colElements.forEach((col, i) => {
    if (mode === "fixed") {
      col.style.width = fixedWidth + "px";
    } else {
      col.style.width = (100 / colCount) + "%";
    }
  });
}

// éå†æ‰€æœ‰ Confluence è¡¨æ ¼
document.querySelectorAll("table.confluenceTable").forEach(table => {
  adjustTableColumns(table, "average"); // æˆ– "fixed"
});


---

ğŸ”‘ ä¸ºä»€ä¹ˆç”¨ `<colgroup>`

â€¢ <td> å’Œ <th> çš„å®½åº¦åªæ˜¯å»ºè®®ï¼Œæµè§ˆå™¨ä¼šæ ¹æ®å†…å®¹è‡ªåŠ¨è°ƒæ•´ï¼Œå®¹æ˜“å¤±æ•ˆã€‚
â€¢ <colgroup> å’Œ <col> æ˜¯ä¸“é—¨ç”¨æ¥å®šä¹‰åˆ—å®½çš„ï¼Œèƒ½ä¿è¯æ‰€æœ‰å•å…ƒæ ¼ç»Ÿä¸€ã€‚
â€¢ è¿™æ ·ä½ åªéœ€è¦è®¾ç½®ä¸€æ¬¡ï¼Œä¸å¿…é€ä¸ªå•å…ƒæ ¼å»æ”¹ã€‚


---

âš™ï¸ åŠ¨æ€åŠ è½½æ”¯æŒ

å¦‚æœ Confluence é¡µé¢æ˜¯ SPAï¼Œå¯ä»¥ç”¨ MutationObserverï¼š

const observer = new MutationObserver(() => {
  document.querySelectorAll("table.confluenceTable").forEach(table => {
    adjustTableColumns(table, "average");
  });
});

observer.observe(document.body, { childList: true, subtree: true });


---

è¿™æ ·ä½ å°±èƒ½ç¨³å®šåœ°è·å–è¡¨æ ¼ï¼Œå¹¶ä¸”å‡†ç¡®è°ƒæ•´æ¯ä¸€åˆ—çš„å®½åº¦ã€‚

è¦ä¸è¦æˆ‘å¸®ä½ å†™ä¸€ä¸ª å®Œæ•´æ’ä»¶ç‰ˆæœ¬ï¼Œç›´æ¥ç”¨ <colgroup> æ¥æ§åˆ¶åˆ—å®½ï¼Œè€Œä¸æ˜¯é€ä¸ª <td>ï¼Œè¿™æ ·æ›´ç¨³å¥ï¼Ÿ




å¿«å¿«å¿«å¿«å¿«å¿«å¿«

å¤ªæ£’äº† ğŸ™Œï¼Œé‚£æˆ‘å°±ç»™ä½ ä¸€ä¸ª å®Œæ•´æ’ä»¶ç‰ˆæœ¬ï¼Œç›´æ¥ç”¨ <colgroup> æ¥æ§åˆ¶åˆ—å®½ï¼Œè¿™æ ·æ¯”é€ä¸ª <td>ã€<th> ç¨³å®šå¾—å¤šã€‚

---

ğŸ“‚ æ–‡ä»¶ç»“æ„

confluence-table-fix/
 â”œâ”€ manifest.json
 â”œâ”€ content.js
 â”œâ”€ options.html
 â””â”€ options.js


---

ğŸ“œ manifest.json

{
  "manifest_version": 3,
  "name": "Confluence Table Auto Width",
  "version": "2.0",
  "description": "è‡ªåŠ¨è°ƒæ•´ Confluence è¡¨æ ¼åˆ—å®½ï¼ˆä½¿ç”¨ colgroupï¼Œæ”¯æŒåŠ¨æ€åŠ è½½ + é…ç½® + å¿«æ·é”®ï¼‰",
  "permissions": ["storage", "scripting"],
  "options_page": "options.html",
  "background": {
    "service_worker": "background.js"
  },
  "commands": {
    "adjust-tables": {
      "suggested_key": {
        "default": "Ctrl+Shift+T"
      },
      "description": "æ‰‹åŠ¨è°ƒæ•´å½“å‰é¡µé¢çš„è¡¨æ ¼åˆ—å®½"
    }
  },
  "content_scripts": [
    {
      "matches": ["https://*.atlassian.net/*"],
      "js": ["content.js"],
      "run_at": "document_idle"
    }
  ]
}


---

ğŸ“œ content.js

function adjustTableColumns(table, mode = "average", fixedWidth = 150) {
  const firstRow = table.querySelector("tr");
  if (!firstRow) return;

  const cols = firstRow.querySelectorAll("td, th");
  const colCount = cols.length;
  if (colCount === 0) return;

  // å¦‚æœæ²¡æœ‰ colgroupï¼Œå…ˆåˆ›å»º
  let colgroup = table.querySelector("colgroup");
  if (!colgroup) {
    colgroup = document.createElement("colgroup");
    for (let i = 0; i < colCount; i++) {
      const col = document.createElement("col");
      colgroup.appendChild(col);
    }
    table.insertBefore(colgroup, table.firstChild);
  }

  // è®¾ç½®å®½åº¦
  const colElements = colgroup.querySelectorAll("col");
  colElements.forEach((col, i) => {
    if (mode === "fixed") {
      col.style.width = fixedWidth + "px";
    } else {
      col.style.width = (100 / colCount) + "%";
    }
  });
}

function init() {
  chrome.storage.sync.get(["mode", "fixedWidth"], data => {
    const mode = data.mode || "average"; // é»˜è®¤å¹³å‡åˆ†é…
    const fixedWidth = data.fixedWidth || 150;
    document.querySelectorAll("table.confluenceTable").forEach(table => {
      adjustTableColumns(table, mode, fixedWidth);
    });
  });
}

// åˆæ¬¡åŠ è½½æ‰§è¡Œ
window.addEventListener("load", init);

// ç›‘å¬ DOM å˜åŒ–ï¼ˆåŠ¨æ€åŠ è½½ï¼‰
const observer = new MutationObserver(init);
observer.observe(document.body, { childList: true, subtree: true });

// ç›‘å¬å¿«æ·é”®å‘½ä»¤
chrome.runtime.onMessage.addListener((request) => {
  if (request.action === "adjustTables") {
    init();
  }
});


---

ğŸ“œ background.js

chrome.commands.onCommand.addListener((command) => {
  if (command === "adjust-tables") {
    chrome.tabs.query({active: true, currentWindow: true}, (tabs) => {
      chrome.tabs.sendMessage(tabs[0].id, {action: "adjustTables"});
    });
  }
});


---

ğŸ“œ options.html

<!DOCTYPE html>
<html>
<head>
  <title>Confluence Table Auto Width è®¾ç½®</title>
</head>
<body>
  <h2>è¡¨æ ¼åˆ—å®½è®¾ç½®</h2>
  <label>
    <input type="radio" name="mode" value="fixed"> å›ºå®šå®½åº¦
  </label>
  <input type="number" id="fixedWidth" value="150"> px<br><br>
  <label>
    <input type="radio" name="mode" value="average"> å¹³å‡åˆ†é…
  </label><br><br>
  <button id="save">ä¿å­˜</button>

  <script src="options.js"></script>
</body>
</html>


---

ğŸ“œ options.js

document.addEventListener("DOMContentLoaded", () => {
  chrome.storage.sync.get(["mode", "fixedWidth"], data => {
    if (data.mode) {
      document.querySelector(`input[value=${data.mode}]`).checked = true;
    }
    if (data.fixedWidth) {
      document.getElementById("fixedWidth").value = data.fixedWidth;
    }
  });

  document.getElementById("save").addEventListener("click", () => {
    const mode = document.querySelector("input[name=mode]:checked").value;
    const fixedWidth = parseInt(document.getElementById("fixedWidth").value, 10);
    chrome.storage.sync.set({ mode, fixedWidth });
    alert("è®¾ç½®å·²ä¿å­˜ï¼");
  });
});


---

âš™ï¸ åŠŸèƒ½æ€»ç»“

â€¢ è‡ªåŠ¨è°ƒæ•´ï¼šæ‰€æœ‰ Confluence è¡¨æ ¼åˆ—å®½ç»Ÿä¸€
â€¢ åŠ¨æ€æ”¯æŒï¼šé¡µé¢å†…å®¹æ›´æ–°æ—¶è‡ªåŠ¨è°ƒæ•´
â€¢ é…ç½®é€‰é¡¹ï¼šå¯é€‰æ‹©ã€Œå›ºå®šå®½åº¦ã€æˆ–ã€Œå¹³å‡åˆ†é…ã€ï¼Œå›ºå®šå®½åº¦å¯è‡ªå®šä¹‰ px å€¼
â€¢ å¿«æ·é”®ï¼šæŒ‰ä¸‹ Ctrl+Shift+T æ‰‹åŠ¨åˆ·æ–°è¡¨æ ¼å¸ƒå±€


---

è¿™æ ·ä½ å°±æœ‰ä¸€ä¸ª å®Œæ•´ã€å¯é…ç½®ã€ç¨³å®šçš„æ’ä»¶ï¼Œç›´æ¥ç”¨ <colgroup> æ§åˆ¶åˆ—å®½ï¼Œæ•ˆæœæ¯”é€ä¸ª <td> å¼ºå¾ˆå¤šã€‚

è¦ä¸è¦æˆ‘å†å¸®ä½ åŠ ä¸€ä¸ª åªé’ˆå¯¹ç‰¹å®šç©ºé—´æˆ–é¡µé¢ç”Ÿæ•ˆçš„è¿‡æ»¤åŠŸèƒ½ï¼Œæ¯”å¦‚åªåœ¨æŸä¸ª Confluence Space çš„ URL ä¸‹åº”ç”¨ï¼Ÿ




