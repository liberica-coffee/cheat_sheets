å¥½é—®é¢˜ ğŸ‘ã€‚ä½ æƒ³ç”¨ grpcurl æ¥æ¨¡æ‹Ÿ/æµ‹è¯•æœåŠ¡ç«¯çš„ã€Œæœ‰ sessionã€å’Œã€Œæ—  sessionã€ä¸¤ç§è°ƒç”¨çŠ¶æ€ï¼Œå¹¶ä¸”åŒºåˆ†ç”¨æˆ·æ˜¯å¦å·²ç™»å½•ã€‚è¿™é‡Œçš„å…³é”®ç‚¹åœ¨äºï¼š

1. grpcurl æœ¬èº«ä¸ç»´æŠ¤ sessionâ€¢ grpcurl æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨æ¥ç›´æ¥è°ƒç”¨ gRPC æ–¹æ³•ã€‚å®ƒä¸ä¼šåƒæµè§ˆå™¨æˆ–å®¢æˆ·ç«¯ SDK é‚£æ ·è‡ªåŠ¨ä¿å­˜ cookie æˆ– sessionã€‚
â€¢ æ‰€è°“ã€Œæœ‰/æ—  sessionã€å…¶å®å°±æ˜¯ä½ åœ¨è¯·æ±‚å¤´é‡Œæ˜¯å¦å¸¦ä¸Šè®¤è¯ä¿¡æ¯ï¼ˆä¾‹å¦‚ tokenï¼‰ã€‚

2. å¸¸è§åšæ³•ï¼šç”¨ Metadata æ¨¡æ‹Ÿ session
åœ¨ gRPC ä¸­ï¼Œsession æˆ–ç™»å½•çŠ¶æ€é€šå¸¸é€šè¿‡ metadata headerï¼ˆæ¯”å¦‚ authorizationï¼‰ä¼ é€’ã€‚â€¢ æ—  session / æœªç™»å½•ï¼šç›´æ¥è°ƒç”¨ï¼Œä¸å¸¦ä»»ä½• headerã€‚grpcurl -plaintext localhost:50051 my.service.UserService/GetProfile

â€¢ æœ‰ session / å·²ç™»å½•ï¼šåœ¨è°ƒç”¨æ—¶åŠ ä¸Šè®¤è¯ tokenã€‚grpcurl -plaintext \
  -H "authorization: Bearer <ACCESS_TOKEN>" \
  localhost:50051 my.service.UserService/GetProfile


3. åŒºåˆ†ç”¨æˆ·æ˜¯å¦ç™»å½•â€¢ å¦‚æœæœåŠ¡ç«¯è¦æ±‚ç™»å½•æ‰èƒ½è®¿é—®æŸäº›æ–¹æ³•ï¼Œé‚£ä¹ˆæœªå¸¦ token çš„è°ƒç”¨ä¼šè¿”å› Unauthenticated é”™è¯¯ã€‚
â€¢ å¦‚æœå¸¦äº†åˆæ³• tokenï¼Œå°±èƒ½æˆåŠŸè¿”å›æ•°æ®ã€‚
â€¢ ä½ å¯ä»¥é€šè¿‡å‡†å¤‡ä¸åŒçš„å‘½ä»¤æ¥æµ‹è¯•è¿™ä¸¤ç§æƒ…å†µã€‚

4. æ‰©å±•ï¼šæ¨¡æ‹Ÿä¸åŒç”¨æˆ·â€¢ åªè¦æ¢ä¸åŒçš„ tokenï¼Œå°±èƒ½æ¨¡æ‹Ÿä¸åŒç”¨æˆ·çš„ sessionã€‚
â€¢ ä¾‹å¦‚ï¼šgrpcurl -plaintext \
  -H "authorization: Bearer userA_token" \
  localhost:50051 my.service.UserService/GetProfile
grpcurl -plaintext \
  -H "authorization: Bearer userB_token" \
  localhost:50051 my.service.UserService/GetProfile




---

âœ… æ€»ç»“ï¼š

â€¢ grpcurl æ²¡æœ‰å†…å»º session æ¦‚å¿µã€‚
â€¢ ã€Œæœ‰/æ—  sessionã€å°±æ˜¯æ˜¯å¦åœ¨å‘½ä»¤é‡ŒåŠ ä¸Š -H "authorization: Bearer <token>"ã€‚
â€¢ ç”¨æˆ·æ˜¯å¦ç™»å½•ç”±æœåŠ¡ç«¯éªŒè¯ token å†³å®šã€‚


è¦ä¸è¦æˆ‘å¸®ä½ å†™ä¸€ä¸ª å¯¹ç…§è¡¨ï¼ŒæŠŠã€Œæœªç™»å½•ã€ã€Œå·²ç™»å½•ã€ã€Œä¸åŒç”¨æˆ·ã€çš„ grpcurl å‘½ä»¤æ•´ç†æˆä¸€ä»½å¿«é€Ÿå‚è€ƒæ¸…å•ï¼Ÿ


sessioné‡Œé¢æœ‰ç”¨æˆ·ç™»é™†ä¿¡æ¯çš„è¯ï¼Œæ€ä¹ˆåœ¨grpcä¸­æºå¸¦å’Œä¼ é€’ç”¨æˆ·ä¿¡æ¯

åœ¨ gRPC é‡Œï¼Œsession æˆ–ç”¨æˆ·ç™»å½•ä¿¡æ¯é€šå¸¸ä¸ä¼šåƒä¼ ç»Ÿ Web é‚£æ ·é  cookie è‡ªåŠ¨ä¼ é€’ï¼Œè€Œæ˜¯é€šè¿‡ metadataï¼ˆå…ƒæ•°æ®ï¼‰ æˆ– token æ¥æºå¸¦ã€‚ä½ å¯ä»¥æŠŠç”¨æˆ·çš„ç™»å½•çŠ¶æ€ã€IDã€è§’è‰²ç­‰ä¿¡æ¯æ”¾åœ¨ metadata é‡Œï¼Œç”±æœåŠ¡ç«¯æ‹¦æˆªå™¨æˆ–ä¸­é—´ä»¶ç»Ÿä¸€è§£æã€‚ä¸‹é¢åˆ†å±‚è¯´æ˜ï¼š

---

ğŸ”‘ å¸¸è§åšæ³•ï¼šä½¿ç”¨ Metadata æºå¸¦ç”¨æˆ·ä¿¡æ¯

â€¢ å®¢æˆ·ç«¯è°ƒç”¨æ—¶åŠ  headergrpcurl -plaintext \
  -H "authorization: Bearer <ACCESS_TOKEN>" \
  -H "x-user-id: 12345" \
  -H "x-user-role: admin" \
  localhost:50051 my.service.UserService/GetProfile
â€¢ authorizationï¼šå¸¸è§çš„ç™»å½• tokenï¼ˆJWTã€OAuth2 ç­‰ï¼‰ã€‚
â€¢ x-user-idï¼šç”¨æˆ· IDã€‚
â€¢ x-user-roleï¼šè§’è‰²æˆ–æƒé™ä¿¡æ¯ã€‚

â€¢ æœåŠ¡ç«¯æ‹¦æˆªå™¨è§£æ
åœ¨æœåŠ¡ç«¯å†™ä¸€ä¸ª UnaryInterceptor æˆ– StreamInterceptorï¼Œç»Ÿä¸€è¯»å– metadataï¼šclass AuthInterceptor : ServerInterceptor {
    override fun <ReqT, RespT> interceptCall(
        call: ServerCall<ReqT, RespT>,
        headers: Metadata,
        next: ServerCallHandler<ReqT, RespT>
    ): ServerCall.Listener<ReqT> {
        val token = headers.get(Metadata.Key.of("authorization", Metadata.ASCII_STRING_MARSHALLER))
        val userId = headers.get(Metadata.Key.of("x-user-id", Metadata.ASCII_STRING_MARSHALLER))
        // éªŒè¯ tokenï¼Œè§£æç”¨æˆ·ä¿¡æ¯ï¼Œå­˜å…¥ Context
        val ctx = Context.current().withValue(USER_ID_CTX_KEY, userId)
        return Contexts.interceptCall(ctx, call, headers, next)
    }
}



---

ğŸ“¦ åœ¨ Context ä¸­ä¼ é€’ç”¨æˆ·ä¿¡æ¯

â€¢ gRPC æä¾› Contextï¼Œå¯ä»¥åœ¨æ‹¦æˆªå™¨é‡ŒæŠŠè§£æå¥½çš„ç”¨æˆ·ä¿¡æ¯æ”¾è¿›å»ã€‚
â€¢ åœ¨å…·ä½“çš„ service æ–¹æ³•é‡Œå†å–å‡ºï¼šval userId = USER_ID_CTX_KEY.get()



è¿™æ ·å°±å®ç°äº†ã€Œsession å†…æœ‰ç”¨æˆ·ç™»å½•ä¿¡æ¯ â†’ åœ¨ gRPC è°ƒç”¨ä¸­æºå¸¦ â†’ æœåŠ¡ç«¯è§£æå¹¶ä¼ é€’åˆ°ä¸šåŠ¡é€»è¾‘ã€ã€‚

---

âš–ï¸ å¯¹æ¯”ï¼šSession vs Token

æ–¹å¼	ç‰¹ç‚¹	åœ¨ gRPC ä¸­çš„å®ç°	
Sessionï¼ˆä¼ ç»Ÿ cookieï¼‰	ä¾èµ–æœåŠ¡ç«¯ä¿å­˜çŠ¶æ€ï¼Œå®¢æˆ·ç«¯åªä¼  session ID	ä¸å¸¸ç”¨ï¼Œé€šå¸¸æ”¹ä¸º token	
Tokenï¼ˆJWT/OAuth2ï¼‰	æ— çŠ¶æ€ï¼Œå®¢æˆ·ç«¯æ¯æ¬¡è°ƒç”¨éƒ½å¸¦ token	å¸¸è§åšæ³•ï¼Œç”¨ metadata header æºå¸¦	


---

âœ… æ€»ç»“ï¼š
åœ¨ gRPC ä¸­ï¼Œç”¨æˆ·ç™»å½•ä¿¡æ¯è¦é€šè¿‡ metadata header æºå¸¦ï¼ŒæœåŠ¡ç«¯ç”¨æ‹¦æˆªå™¨è§£æå¹¶æ”¾å…¥ Contextï¼Œä¸šåŠ¡é€»è¾‘å°±èƒ½è·å–åˆ°ç”¨æˆ·ä¿¡æ¯ã€‚è¿™æ ·æ—¢èƒ½æ¨¡æ‹Ÿã€Œæœ‰ sessionã€çš„çŠ¶æ€ï¼Œä¹Ÿèƒ½ä¿æŒ gRPC çš„æ— çŠ¶æ€ç‰¹æ€§ã€‚

è¦ä¸è¦æˆ‘å¸®ä½ å†™ä¸€ä¸ª å®Œæ•´çš„ Kotlin + Spring Boot gRPC ç¤ºä¾‹ï¼Œå±•ç¤ºå®¢æˆ·ç«¯å¦‚ä½•ä¼  metadataï¼ŒæœåŠ¡ç«¯å¦‚ä½•æ‹¦æˆªå¹¶è§£æç”¨æˆ·ä¿¡æ¯ï¼Ÿ

å¥½çš„ï¼Œæˆ‘ä»¬æ¥å…·ä½“çœ‹ä¸€ä¸‹ gRPC çš„ Context éƒ¨åˆ†å¦‚ä½•å®ç°ç”¨æˆ·ä¿¡æ¯ä¼ é€’ã€‚æ ¸å¿ƒæ€è·¯æ˜¯ï¼š

â€¢ åœ¨ æ‹¦æˆªå™¨é‡Œè§£æ metadataï¼ˆæ¯”å¦‚ tokenã€userIdï¼‰ã€‚
â€¢ æŠŠè§£æç»“æœæ”¾åˆ° Contextã€‚
â€¢ åœ¨ä¸šåŠ¡æ–¹æ³•é‡Œé€šè¿‡ Context å–å‡ºç”¨æˆ·ä¿¡æ¯ã€‚


ä¸‹é¢ç»™ä½ ä¸€ä¸ªå®Œæ•´çš„ Kotlin + gRPC ç¤ºä¾‹ï¼š

---

1ï¸âƒ£ å®šä¹‰ Context Key

// å®šä¹‰ä¸€ä¸ª Context Keyï¼Œç”¨æ¥å­˜å‚¨ç”¨æˆ· ID
val USER_ID_CTX_KEY: Context.Key<String> = Context.key("userId")


---

2ï¸âƒ£ ç¼–å†™æ‹¦æˆªå™¨

class AuthInterceptor : ServerInterceptor {
    override fun <ReqT, RespT> interceptCall(
        call: ServerCall<ReqT, RespT>,
        headers: Metadata,
        next: ServerCallHandler<ReqT, RespT>
    ): ServerCall.Listener<ReqT> {

        // ä» metadata ä¸­å–å‡ºç”¨æˆ·ä¿¡æ¯
        val token = headers.get(Metadata.Key.of("authorization", Metadata.ASCII_STRING_MARSHALLER))
        val userId = headers.get(Metadata.Key.of("x-user-id", Metadata.ASCII_STRING_MARSHALLER))

        // è¿™é‡Œå¯ä»¥åš token éªŒè¯ï¼Œæˆ–è€…æŸ¥æ•°æ®åº“
        val verifiedUserId = if (token != null && userId != null) userId else "anonymous"

        // æŠŠç”¨æˆ·ä¿¡æ¯æ”¾å…¥ Context
        val ctx = Context.current().withValue(USER_ID_CTX_KEY, verifiedUserId)

        // ç”¨æ–°çš„ Context ç»§ç»­è°ƒç”¨é“¾
        return Contexts.interceptCall(ctx, call, headers, next)
    }
}


---

3ï¸âƒ£ åœ¨ Service æ–¹æ³•é‡Œå–å‡ºç”¨æˆ·ä¿¡æ¯

class UserServiceImpl : UserServiceGrpc.UserServiceImplBase() {
    override fun getProfile(request: GetProfileRequest, responseObserver: StreamObserver<GetProfileResponse>) {
        // ä» Context ä¸­å–å‡ºç”¨æˆ· ID
        val userId = USER_ID_CTX_KEY.get()

        val response = GetProfileResponse.newBuilder()
            .setUserId(userId)
            .setMessage("Hello, user $userId")
            .build()

        responseObserver.onNext(response)
        responseObserver.onCompleted()
    }
}


---

4ï¸âƒ£ å®¢æˆ·ç«¯è°ƒç”¨ç¤ºä¾‹

â€¢ æœªç™»å½•ï¼ˆæ—  sessionï¼‰grpcurl -plaintext localhost:50051 my.service.UserService/GetProfile
â†’ æœåŠ¡ç«¯ä¼šè¿”å› userId = anonymous
â€¢ å·²ç™»å½•ï¼ˆæœ‰ sessionï¼‰grpcurl -plaintext \
  -H "authorization: Bearer abc123" \
  -H "x-user-id: 42" \
  localhost:50051 my.service.UserService/GetProfile
â†’ æœåŠ¡ç«¯ä¼šè¿”å› userId = 42


---

âœ… æ€»ç»“ï¼š

â€¢ Context æ˜¯ gRPC å†…éƒ¨ä¼ é€’ç”¨æˆ·ä¿¡æ¯çš„å…³é”®ã€‚
â€¢ åœ¨æ‹¦æˆªå™¨é‡Œè§£æ metadata â†’ å­˜å…¥ Context â†’ åœ¨ä¸šåŠ¡æ–¹æ³•é‡Œå–å‡ºã€‚
â€¢ è¿™æ ·å°±èƒ½æ¨¡æ‹Ÿã€Œæœ‰ session / æ—  sessionã€å’Œã€Œç”¨æˆ·æ˜¯å¦ç™»å½•ã€çš„çŠ¶æ€ã€‚


è¦ä¸è¦æˆ‘å¸®ä½ æ‰©å±•ä¸€ä¸‹ï¼ŒæŠŠ è§’è‰²/æƒé™ä¿¡æ¯ï¼ˆæ¯”å¦‚ x-user-role: adminï¼‰ä¹Ÿæ”¾è¿› Contextï¼Œå¹¶å±•ç¤ºå¦‚ä½•åœ¨ä¸šåŠ¡é€»è¾‘é‡Œåšæƒé™åˆ¤æ–­ï¼Ÿ

ç”¨æˆ·åœ¨ç™»é™†é¡µé¢ç™»å½•äº†çš„ä¿¡æ¯ï¼Œæ€æ ·é€šè¿‡contextæˆ–è€…metadata ä¼ é€’ï¼Œç„¶ååœ¨apiç«¯ç™»å½•





