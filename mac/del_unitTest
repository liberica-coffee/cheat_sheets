我来为你详细介绍在 MacBook Pro 上使用 IntelliJ 为 Spring Boot + Gradle + Kotlin 项目创建单元测试的完整步骤。

1. 环境准备

确认项目结构

确保你的 build.gradle.kts 包含测试依赖：

```kotlin
plugins {
    kotlin("jvm")
    kotlin("plugin.spring")
    id("org.springframework.boot")
    id("io.spring.dependency-management")
}

dependencies {
    implementation("org.springframework.boot:spring-boot-starter")
    implementation("org.jetbrains.kotlin:kotlin-reflect")
    implementation("org.jetbrains.kotlin:kotlin-stdlib-jdk8")
    
    // 测试依赖
    testImplementation("org.springframework.boot:spring-boot-starter-test")
    testImplementation("org.jetbrains.kotlin:kotlin-test")
    testImplementation("org.jetbrains.kotlin:kotlin-test-junit5")
}
```

2. 创建测试目录结构

在 IntelliJ 中：

· 项目通常会自动创建 src/test/kotlin 目录
· 如果没有，手动创建：

```bash
mkdir -p src/test/kotlin/com/yourpackage
```

3. 创建简单的单元测试

示例：测试 Service 类

首先创建要测试的 Service：
src/main/kotlin/com/example/service/UserService.kt

```kotlin
package com.example.service

import org.springframework.stereotype.Service

@Service
class UserService {
    
    fun getUserFullName(firstName: String, lastName: String): String {
        return "$firstName $LastName"
    }
    
    fun isAdult(age: Int): Boolean {
        return age >= 18
    }
    
    fun calculateDiscount(price: Double, discountRate: Double): Double {
        require(price >= 0) { "Price cannot be negative" }
        require(discountRate in 0.0..100.0) { "Discount rate must be between 0 and 100" }
        return price * (1 - discountRate / 100)
    }
}
```

创建对应的测试类：
src/test/kotlin/com/example/service/UserServiceTest.kt

```kotlin
package com.example.service

import org.junit.jupiter.api.Test
import org.junit.jupiter.api.Assertions.*
import org.junit.jupiter.api.BeforeEach
import org.junit.jupiter.api.DisplayName
import org.junit.jupiter.api.assertThrows

class UserServiceTest {
    
    private lateinit var userService: UserService
    
    @BeforeEach
    fun setUp() {
        userService = UserService()
    }
    
    @Test
    @DisplayName("应该正确返回用户全名")
    fun `should return full name correctly`() {
        // Given
        val firstName = "John"
        val lastName = "Doe"
        
        // When
        val result = userService.getUserFullName(firstName, lastName)
        
        // Then
        assertEquals("John Doe", result)
    }
    
    @Test
    @DisplayName("当年龄大于等于18岁时应该返回true")
    fun `should return true when age is 18 or above`() {
        // Test cases for adult
        assertTrue(userService.isAdult(18))
        assertTrue(userService.isAdult(25))
        
        // Test cases for minor
        assertFalse(userService.isAdult(17))
        assertFalse(userService.isAdult(10))
    }
    
    @Test
    @DisplayName("应该正确计算折扣价格")
    fun `should calculate discount price correctly`() {
        // Given
        val price = 100.0
        val discountRate = 20.0
        
        // When
        val result = userService.calculateDiscount(price, discountRate)
        
        // Then
        assertEquals(80.0, result, 0.001)
    }
    
    @Test
    @DisplayName("当价格为负时应该抛出异常")
    fun `should throw exception when price is negative`() {
        // When & Then
        val exception = assertThrows<IllegalArgumentException> {
            userService.calculateDiscount(-10.0, 20.0)
        }
        
        assertTrue(exception.message!!.contains("Price cannot be negative"))
    }
}
```

4. 运行测试

在 IntelliJ 中运行：

1. 运行单个测试：点击测试方法旁边的绿色播放按钮
2. 运行整个测试类：点击类名旁边的绿色播放按钮
3. 运行所有测试：右键 src/test/kotlin → "Run Tests in 'test'"

使用 Gradle 命令运行：

```bash
# 运行所有测试
./gradlew test

# 运行特定测试类
./gradlew test --tests "com.example.service.UserServiceTest"

# 运行特定测试方法
./gradlew test --tests "com.example.service.UserServiceTest.should return full name correctly"

# 生成测试报告
./gradlew test
# 报告位置：build/reports/tests/test/index.html
```

5. 测试 Spring Boot 组件

测试 Controller：

src/test/kotlin/com/example/controller/UserControllerTest.kt

```kotlin
package com.example.controller

import com.example.service.UserService
import org.junit.jupiter.api.Test
import org.mockito.Mockito.`when`
import org.mockito.Mockito.mock
import org.springframework.beans.factory.annotation.Autowired
import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest
import org.springframework.boot.test.mock.mockito.MockBean
import org.springframework.test.web.servlet.MockMvc
import org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get
import org.springframework.test.web.servlet.result.MockMvcResultMatchers.*

@WebMvcTest(UserController::class)
class UserControllerTest {
    
    @Autowired
    private lateinit var mockMvc: MockMvc
    
    @MockBean
    private lateinit var userService: UserService
    
    @Test
    fun `should return user info`() {
        // Given
        `when`(userService.getUserFullName("John", "Doe")).thenReturn("John Doe")
        
        // When & Then
        mockMvc.perform(get("/api/users/name")
            .param("firstName", "John")
            .param("lastName", "Doe"))
            .andExpect(status().isOk)
            .andExpect(content().string("John Doe"))
    }
}
```

测试 Repository（使用 @DataJpaTest）：

src/test/kotlin/com/example/repository/UserRepositoryTest.kt

```kotlin
package com.example.repository

import org.junit.jupiter.api.Test
import org.springframework.beans.factory.annotation.Autowired
import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest
import org.springframework.test.context.TestPropertySource

@DataJpaTest
@TestPropertySource(properties = ["spring.jpa.hibernate.ddl-auto=create-drop"])
class UserRepositoryTest {
    
    @Autowired
    private lateinit var userRepository: UserRepository
    
    @Test
    fun `should save and find user`() {
        // Given
        val user = User(name = "John Doe", email = "john@example.com")
        
        // When
        val savedUser = userRepository.save(user)
        val foundUser = userRepository.findById(savedUser.id!!)
        
        // Then
        assertTrue(foundUser.isPresent)
        assertEquals("John Doe", foundUser.get().name)
    }
}
```

6. 配置测试设置

在 build.gradle.kts 中添加测试配置：

```kotlin
tasks.test {
    useJUnitPlatform()
    testLogging {
        events("passed", "skipped", "failed")
    }
}

// 配置 Kotlin 编译选项
kotlin {
    jvmToolchain(17)
}
```

创建测试配置文件：

src/test/resources/application-test.properties

```properties
spring.datasource.url=jdbc:h2:mem:testdb
spring.jpa.hibernate.ddl-auto=create-drop
spring.jpa.show-sql=true
```

7. 常用测试快捷键（IntelliJ）

· ⌘⇧T：在类和测试类之间跳转
· ⌃⇧R：运行测试
· ⌃⇧D：调试测试
· ⌘N 在测试类中：快速生成测试方法

8. 查看测试结果

· IntelliJ 的 Run 窗口：显示详细的测试结果
· Gradle 测试报告：build/reports/tests/test/index.html
· 覆盖率报告：运行 with coverage (⌃⇧F6)

这样你就有了完整的测试环境设置！需要我详细解释任何特定部分吗？
