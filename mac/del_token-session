å¥½é—®é¢˜ ğŸ‘ã€‚ä½ æƒ³ç”¨ grpcurl æ¥æ¨¡æ‹Ÿ/æµ‹è¯•æœåŠ¡ç«¯çš„ã€Œæœ‰ sessionã€å’Œã€Œæ—  sessionã€ä¸¤ç§è°ƒç”¨çŠ¶æ€ï¼Œå¹¶ä¸”åŒºåˆ†ç”¨æˆ·æ˜¯å¦å·²ç™»å½•ã€‚è¿™é‡Œçš„å…³é”®ç‚¹åœ¨äºï¼š

1. grpcurl æœ¬èº«ä¸ç»´æŠ¤ sessionâ€¢ grpcurl æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨æ¥ç›´æ¥è°ƒç”¨ gRPC æ–¹æ³•ã€‚å®ƒä¸ä¼šåƒæµè§ˆå™¨æˆ–å®¢æˆ·ç«¯ SDK é‚£æ ·è‡ªåŠ¨ä¿å­˜ cookie æˆ– sessionã€‚
â€¢ æ‰€è°“ã€Œæœ‰/æ—  sessionã€å…¶å®å°±æ˜¯ä½ åœ¨è¯·æ±‚å¤´é‡Œæ˜¯å¦å¸¦ä¸Šè®¤è¯ä¿¡æ¯ï¼ˆä¾‹å¦‚ tokenï¼‰ã€‚

2. å¸¸è§åšæ³•ï¼šç”¨ Metadata æ¨¡æ‹Ÿ session
åœ¨ gRPC ä¸­ï¼Œsession æˆ–ç™»å½•çŠ¶æ€é€šå¸¸é€šè¿‡ metadata headerï¼ˆæ¯”å¦‚ authorizationï¼‰ä¼ é€’ã€‚â€¢ æ—  session / æœªç™»å½•ï¼šç›´æ¥è°ƒç”¨ï¼Œä¸å¸¦ä»»ä½• headerã€‚grpcurl -plaintext localhost:50051 my.service.UserService/GetProfile

â€¢ æœ‰ session / å·²ç™»å½•ï¼šåœ¨è°ƒç”¨æ—¶åŠ ä¸Šè®¤è¯ tokenã€‚grpcurl -plaintext \
  -H "authorization: Bearer <ACCESS_TOKEN>" \
  localhost:50051 my.service.UserService/GetProfile


3. åŒºåˆ†ç”¨æˆ·æ˜¯å¦ç™»å½•â€¢ å¦‚æœæœåŠ¡ç«¯è¦æ±‚ç™»å½•æ‰èƒ½è®¿é—®æŸäº›æ–¹æ³•ï¼Œé‚£ä¹ˆæœªå¸¦ token çš„è°ƒç”¨ä¼šè¿”å› Unauthenticated é”™è¯¯ã€‚
â€¢ å¦‚æœå¸¦äº†åˆæ³• tokenï¼Œå°±èƒ½æˆåŠŸè¿”å›æ•°æ®ã€‚
â€¢ ä½ å¯ä»¥é€šè¿‡å‡†å¤‡ä¸åŒçš„å‘½ä»¤æ¥æµ‹è¯•è¿™ä¸¤ç§æƒ…å†µã€‚

4. æ‰©å±•ï¼šæ¨¡æ‹Ÿä¸åŒç”¨æˆ·â€¢ åªè¦æ¢ä¸åŒçš„ tokenï¼Œå°±èƒ½æ¨¡æ‹Ÿä¸åŒç”¨æˆ·çš„ sessionã€‚
â€¢ ä¾‹å¦‚ï¼šgrpcurl -plaintext \
  -H "authorization: Bearer userA_token" \
  localhost:50051 my.service.UserService/GetProfile
grpcurl -plaintext \
  -H "authorization: Bearer userB_token" \
  localhost:50051 my.service.UserService/GetProfile




---

âœ… æ€»ç»“ï¼š

â€¢ grpcurl æ²¡æœ‰å†…å»º session æ¦‚å¿µã€‚
â€¢ ã€Œæœ‰/æ—  sessionã€å°±æ˜¯æ˜¯å¦åœ¨å‘½ä»¤é‡ŒåŠ ä¸Š -H "authorization: Bearer <token>"ã€‚
â€¢ ç”¨æˆ·æ˜¯å¦ç™»å½•ç”±æœåŠ¡ç«¯éªŒè¯ token å†³å®šã€‚


è¦ä¸è¦æˆ‘å¸®ä½ å†™ä¸€ä¸ª å¯¹ç…§è¡¨ï¼ŒæŠŠã€Œæœªç™»å½•ã€ã€Œå·²ç™»å½•ã€ã€Œä¸åŒç”¨æˆ·ã€çš„ grpcurl å‘½ä»¤æ•´ç†æˆä¸€ä»½å¿«é€Ÿå‚è€ƒæ¸…å•ï¼Ÿ


sessioné‡Œé¢æœ‰ç”¨æˆ·ç™»é™†ä¿¡æ¯çš„è¯ï¼Œæ€ä¹ˆåœ¨grpcä¸­æºå¸¦å’Œä¼ é€’ç”¨æˆ·ä¿¡æ¯

åœ¨ gRPC é‡Œï¼Œsession æˆ–ç”¨æˆ·ç™»å½•ä¿¡æ¯é€šå¸¸ä¸ä¼šåƒä¼ ç»Ÿ Web é‚£æ ·é  cookie è‡ªåŠ¨ä¼ é€’ï¼Œè€Œæ˜¯é€šè¿‡ metadataï¼ˆå…ƒæ•°æ®ï¼‰ æˆ– token æ¥æºå¸¦ã€‚ä½ å¯ä»¥æŠŠç”¨æˆ·çš„ç™»å½•çŠ¶æ€ã€IDã€è§’è‰²ç­‰ä¿¡æ¯æ”¾åœ¨ metadata é‡Œï¼Œç”±æœåŠ¡ç«¯æ‹¦æˆªå™¨æˆ–ä¸­é—´ä»¶ç»Ÿä¸€è§£æã€‚ä¸‹é¢åˆ†å±‚è¯´æ˜ï¼š

---

ğŸ”‘ å¸¸è§åšæ³•ï¼šä½¿ç”¨ Metadata æºå¸¦ç”¨æˆ·ä¿¡æ¯

â€¢ å®¢æˆ·ç«¯è°ƒç”¨æ—¶åŠ  headergrpcurl -plaintext \
  -H "authorization: Bearer <ACCESS_TOKEN>" \
  -H "x-user-id: 12345" \
  -H "x-user-role: admin" \
  localhost:50051 my.service.UserService/GetProfile
â€¢ authorizationï¼šå¸¸è§çš„ç™»å½• tokenï¼ˆJWTã€OAuth2 ç­‰ï¼‰ã€‚
â€¢ x-user-idï¼šç”¨æˆ· IDã€‚
â€¢ x-user-roleï¼šè§’è‰²æˆ–æƒé™ä¿¡æ¯ã€‚

â€¢ æœåŠ¡ç«¯æ‹¦æˆªå™¨è§£æ
åœ¨æœåŠ¡ç«¯å†™ä¸€ä¸ª UnaryInterceptor æˆ– StreamInterceptorï¼Œç»Ÿä¸€è¯»å– metadataï¼šclass AuthInterceptor : ServerInterceptor {
    override fun <ReqT, RespT> interceptCall(
        call: ServerCall<ReqT, RespT>,
        headers: Metadata,
        next: ServerCallHandler<ReqT, RespT>
    ): ServerCall.Listener<ReqT> {
        val token = headers.get(Metadata.Key.of("authorization", Metadata.ASCII_STRING_MARSHALLER))
        val userId = headers.get(Metadata.Key.of("x-user-id", Metadata.ASCII_STRING_MARSHALLER))
        // éªŒè¯ tokenï¼Œè§£æç”¨æˆ·ä¿¡æ¯ï¼Œå­˜å…¥ Context
        val ctx = Context.current().withValue(USER_ID_CTX_KEY, userId)
        return Contexts.interceptCall(ctx, call, headers, next)
    }
}



---

ğŸ“¦ åœ¨ Context ä¸­ä¼ é€’ç”¨æˆ·ä¿¡æ¯

â€¢ gRPC æä¾› Contextï¼Œå¯ä»¥åœ¨æ‹¦æˆªå™¨é‡ŒæŠŠè§£æå¥½çš„ç”¨æˆ·ä¿¡æ¯æ”¾è¿›å»ã€‚
â€¢ åœ¨å…·ä½“çš„ service æ–¹æ³•é‡Œå†å–å‡ºï¼šval userId = USER_ID_CTX_KEY.get()



è¿™æ ·å°±å®ç°äº†ã€Œsession å†…æœ‰ç”¨æˆ·ç™»å½•ä¿¡æ¯ â†’ åœ¨ gRPC è°ƒç”¨ä¸­æºå¸¦ â†’ æœåŠ¡ç«¯è§£æå¹¶ä¼ é€’åˆ°ä¸šåŠ¡é€»è¾‘ã€ã€‚

---

âš–ï¸ å¯¹æ¯”ï¼šSession vs Token

æ–¹å¼	ç‰¹ç‚¹	åœ¨ gRPC ä¸­çš„å®ç°	
Sessionï¼ˆä¼ ç»Ÿ cookieï¼‰	ä¾èµ–æœåŠ¡ç«¯ä¿å­˜çŠ¶æ€ï¼Œå®¢æˆ·ç«¯åªä¼  session ID	ä¸å¸¸ç”¨ï¼Œé€šå¸¸æ”¹ä¸º token	
Tokenï¼ˆJWT/OAuth2ï¼‰	æ— çŠ¶æ€ï¼Œå®¢æˆ·ç«¯æ¯æ¬¡è°ƒç”¨éƒ½å¸¦ token	å¸¸è§åšæ³•ï¼Œç”¨ metadata header æºå¸¦	


---

âœ… æ€»ç»“ï¼š
åœ¨ gRPC ä¸­ï¼Œç”¨æˆ·ç™»å½•ä¿¡æ¯è¦é€šè¿‡ metadata header æºå¸¦ï¼ŒæœåŠ¡ç«¯ç”¨æ‹¦æˆªå™¨è§£æå¹¶æ”¾å…¥ Contextï¼Œä¸šåŠ¡é€»è¾‘å°±èƒ½è·å–åˆ°ç”¨æˆ·ä¿¡æ¯ã€‚è¿™æ ·æ—¢èƒ½æ¨¡æ‹Ÿã€Œæœ‰ sessionã€çš„çŠ¶æ€ï¼Œä¹Ÿèƒ½ä¿æŒ gRPC çš„æ— çŠ¶æ€ç‰¹æ€§ã€‚

è¦ä¸è¦æˆ‘å¸®ä½ å†™ä¸€ä¸ª å®Œæ•´çš„ Kotlin + Spring Boot gRPC ç¤ºä¾‹ï¼Œå±•ç¤ºå®¢æˆ·ç«¯å¦‚ä½•ä¼  metadataï¼ŒæœåŠ¡ç«¯å¦‚ä½•æ‹¦æˆªå¹¶è§£æç”¨æˆ·ä¿¡æ¯ï¼Ÿ

å¥½çš„ï¼Œæˆ‘ä»¬æ¥å…·ä½“çœ‹ä¸€ä¸‹ gRPC çš„ Context éƒ¨åˆ†å¦‚ä½•å®ç°ç”¨æˆ·ä¿¡æ¯ä¼ é€’ã€‚æ ¸å¿ƒæ€è·¯æ˜¯ï¼š

â€¢ åœ¨ æ‹¦æˆªå™¨é‡Œè§£æ metadataï¼ˆæ¯”å¦‚ tokenã€userIdï¼‰ã€‚
â€¢ æŠŠè§£æç»“æœæ”¾åˆ° Contextã€‚
â€¢ åœ¨ä¸šåŠ¡æ–¹æ³•é‡Œé€šè¿‡ Context å–å‡ºç”¨æˆ·ä¿¡æ¯ã€‚


ä¸‹é¢ç»™ä½ ä¸€ä¸ªå®Œæ•´çš„ Kotlin + gRPC ç¤ºä¾‹ï¼š

---

1ï¸âƒ£ å®šä¹‰ Context Key

// å®šä¹‰ä¸€ä¸ª Context Keyï¼Œç”¨æ¥å­˜å‚¨ç”¨æˆ· ID
val USER_ID_CTX_KEY: Context.Key<String> = Context.key("userId")


---

2ï¸âƒ£ ç¼–å†™æ‹¦æˆªå™¨

class AuthInterceptor : ServerInterceptor {
    override fun <ReqT, RespT> interceptCall(
        call: ServerCall<ReqT, RespT>,
        headers: Metadata,
        next: ServerCallHandler<ReqT, RespT>
    ): ServerCall.Listener<ReqT> {

        // ä» metadata ä¸­å–å‡ºç”¨æˆ·ä¿¡æ¯
        val token = headers.get(Metadata.Key.of("authorization", Metadata.ASCII_STRING_MARSHALLER))
        val userId = headers.get(Metadata.Key.of("x-user-id", Metadata.ASCII_STRING_MARSHALLER))

        // è¿™é‡Œå¯ä»¥åš token éªŒè¯ï¼Œæˆ–è€…æŸ¥æ•°æ®åº“
        val verifiedUserId = if (token != null && userId != null) userId else "anonymous"

        // æŠŠç”¨æˆ·ä¿¡æ¯æ”¾å…¥ Context
        val ctx = Context.current().withValue(USER_ID_CTX_KEY, verifiedUserId)

        // ç”¨æ–°çš„ Context ç»§ç»­è°ƒç”¨é“¾
        return Contexts.interceptCall(ctx, call, headers, next)
    }
}


---

3ï¸âƒ£ åœ¨ Service æ–¹æ³•é‡Œå–å‡ºç”¨æˆ·ä¿¡æ¯

class UserServiceImpl : UserServiceGrpc.UserServiceImplBase() {
    override fun getProfile(request: GetProfileRequest, responseObserver: StreamObserver<GetProfileResponse>) {
        // ä» Context ä¸­å–å‡ºç”¨æˆ· ID
        val userId = USER_ID_CTX_KEY.get()

        val response = GetProfileResponse.newBuilder()
            .setUserId(userId)
            .setMessage("Hello, user $userId")
            .build()

        responseObserver.onNext(response)
        responseObserver.onCompleted()
    }
}


---

4ï¸âƒ£ å®¢æˆ·ç«¯è°ƒç”¨ç¤ºä¾‹

â€¢ æœªç™»å½•ï¼ˆæ—  sessionï¼‰grpcurl -plaintext localhost:50051 my.service.UserService/GetProfile
â†’ æœåŠ¡ç«¯ä¼šè¿”å› userId = anonymous
â€¢ å·²ç™»å½•ï¼ˆæœ‰ sessionï¼‰grpcurl -plaintext \
  -H "authorization: Bearer abc123" \
  -H "x-user-id: 42" \
  localhost:50051 my.service.UserService/GetProfile
â†’ æœåŠ¡ç«¯ä¼šè¿”å› userId = 42


---

âœ… æ€»ç»“ï¼š

â€¢ Context æ˜¯ gRPC å†…éƒ¨ä¼ é€’ç”¨æˆ·ä¿¡æ¯çš„å…³é”®ã€‚
â€¢ åœ¨æ‹¦æˆªå™¨é‡Œè§£æ metadata â†’ å­˜å…¥ Context â†’ åœ¨ä¸šåŠ¡æ–¹æ³•é‡Œå–å‡ºã€‚
â€¢ è¿™æ ·å°±èƒ½æ¨¡æ‹Ÿã€Œæœ‰ session / æ—  sessionã€å’Œã€Œç”¨æˆ·æ˜¯å¦ç™»å½•ã€çš„çŠ¶æ€ã€‚


è¦ä¸è¦æˆ‘å¸®ä½ æ‰©å±•ä¸€ä¸‹ï¼ŒæŠŠ è§’è‰²/æƒé™ä¿¡æ¯ï¼ˆæ¯”å¦‚ x-user-role: adminï¼‰ä¹Ÿæ”¾è¿› Contextï¼Œå¹¶å±•ç¤ºå¦‚ä½•åœ¨ä¸šåŠ¡é€»è¾‘é‡Œåšæƒé™åˆ¤æ–­ï¼Ÿ

ç”¨æˆ·åœ¨ç™»é™†é¡µé¢ç™»å½•äº†çš„ä¿¡æ¯ï¼Œæ€æ ·é€šè¿‡contextæˆ–è€…metadata ä¼ é€’ï¼Œç„¶ååœ¨apiç«¯ç™»å½•


kkkk

å¥½é—®é¢˜ ğŸ‘ã€‚ä½ æƒ³è¦çš„æ˜¯ä¸€ä¸ªå®Œæ•´çš„é“¾è·¯ï¼šå‰ç«¯æ³¨å†Œé¡µé¢ â†’ æºå¸¦ç”¨æˆ·ä¿¡æ¯ï¼ˆcontext/metadataï¼‰ â†’ gRPC API â†’ æ•°æ®åº“å…¥åº“ï¼Œå¹¶ä¸”å¸Œæœ›èƒ½ç”¨ grpcurl æ¥æµ‹è¯•ã€‚ä¸‹é¢æˆ‘åˆ†å±‚è§£é‡Šï¼š

---

ğŸ§© 1. å‰ç«¯ä¼ é€’ä¿¡æ¯

â€¢ ç”¨æˆ·åœ¨æ³¨å†Œé¡µé¢è¾“å…¥çš„ä¿¡æ¯ï¼ˆå¦‚ç”¨æˆ·åã€é‚®ç®±ã€å¯†ç ï¼‰ã€‚
â€¢ å‰ç«¯è°ƒç”¨ gRPC API æ—¶ï¼Œå¯ä»¥ï¼šâ€¢ æ”¾åœ¨è¯·æ±‚ä½“ï¼šä½œä¸º message å­—æ®µã€‚
â€¢ æ”¾åœ¨ metadataï¼šä½œä¸ºé¢å¤–çš„ä¸Šä¸‹æ–‡ï¼ˆæ¯”å¦‚ tokenã€trace-idï¼‰ã€‚



ç¤ºä¾‹ï¼ˆprotobuf å®šä¹‰ï¼‰ï¼š

syntax = "proto3";

service AuthService {
  rpc RegisterUser (RegisterRequest) returns (RegisterResponse);
}

message RegisterRequest {
  string username = 1;
  string email = 2;
  string password = 3;
}

message RegisterResponse {
  string userId = 1;
  string status = 2;
}


---

ğŸ§© 2. gRPC Metadata çš„ä½¿ç”¨

â€¢ Metadata å¸¸ç”¨äºä¼ é€’ éä¸šåŠ¡å­—æ®µï¼Œæ¯”å¦‚ï¼šâ€¢ Authorization token
â€¢ Request ID / Trace ID
â€¢ Locale / Client Info



åœ¨ grpcurl ä¸­ï¼Œå¯ä»¥ç”¨ -H ä¼ é€’ï¼š

grpcurl -plaintext \
  -H "authorization: Bearer <token>" \
  -H "x-request-id: 12345" \
  -d '{"username":"arron","email":"arron@example.com","password":"secret"}' \
  localhost:50051 AuthService.RegisterUser


---

ğŸ§© 3. API æœåŠ¡ç«¯å¤„ç†

åœ¨æœåŠ¡ç«¯ï¼ˆä¾‹å¦‚ Go æˆ– Kotlinï¼‰ï¼Œä½ å¯ä»¥ï¼š

â€¢ ä» request message ä¸­å–ä¸šåŠ¡æ•°æ®ã€‚
â€¢ ä» context metadata ä¸­å–é¢å¤–ä¿¡æ¯ã€‚


Go ç¤ºä¾‹ï¼š

func (s *authServer) RegisterUser(ctx context.Context, req *pb.RegisterRequest) (*pb.RegisterResponse, error) {
    md, _ := metadata.FromIncomingContext(ctx)
    token := md["authorization"]

    // å†™å…¥æ•°æ®åº“
    _, err := db.Exec("INSERT INTO users (username, email, password) VALUES ($1, $2, $3)",
        req.Username, req.Email, hashPassword(req.Password))
    if err != nil {
        return nil, err
    }

    return &pb.RegisterResponse{UserId: "123", Status: "success"}, nil
}


---

ğŸ§© 4. æ•°æ®åº“ç™»å½•/å…¥åº“

â€¢ ä¸€èˆ¬æµç¨‹ï¼šAPI å±‚æ‹¿åˆ°æ•°æ® â†’ æ‰§è¡Œ SQL â†’ è¿”å›ç»“æœã€‚
â€¢ æ³¨æ„ï¼šå¯†ç è¦ hashï¼ˆå¦‚ bcrypt/argon2ï¼‰ï¼Œä¸è¦æ˜æ–‡å­˜å‚¨ã€‚


---

ğŸ§© 5. ç”¨ `grpcurl` æµ‹è¯•

å®Œæ•´å‘½ä»¤ï¼š

grpcurl -plaintext \
  -H "authorization: Bearer testtoken" \
  -d '{"username":"arron","email":"arron@example.com","password":"secret"}' \
  localhost:50051 AuthService.RegisterUser


è¿”å›ç»“æœå¯èƒ½æ˜¯ï¼š

{
  "userId": "123",
  "status": "success"
}


---

âœ… æ€»ç»“ï¼š

â€¢ ä¸šåŠ¡æ•°æ®æ”¾åœ¨ request bodyã€‚
â€¢ ä¸Šä¸‹æ–‡ä¿¡æ¯æ”¾åœ¨ metadataã€‚
â€¢ æœåŠ¡ç«¯é€šè¿‡ context è·å– metadataï¼Œé€šè¿‡ req è·å–ä¸šåŠ¡æ•°æ®ã€‚
â€¢ grpcurl ç”¨ -H ä¼  metadataï¼Œç”¨ -d ä¼  bodyã€‚


---

è¦ä¸è¦æˆ‘å¸®ä½ å†™ä¸€ä¸ª æœ€å°å¯è¿è¡Œçš„ gRPC + grpcurl ç¤ºä¾‹ï¼ˆGo æœåŠ¡ç«¯ + Postgres å…¥åº“ï¼‰ï¼Œè¿™æ ·ä½ å¯ä»¥ç›´æ¥è·‘èµ·æ¥ï¼Ÿ



jjjjj


å¾ˆå¥½ï¼ŒArronï¼Œä½ çš„åœºæ™¯æ˜¯ Spring Boot + Kotlin + Gradle + MyBatis + PostgreSQLï¼Œå¹¶ä¸” Web å‰ç«¯å’Œ API åç«¯åˆ†ç¦»ã€‚ä½ å¸Œæœ›åœ¨è‡ªå·±çš„ Mac ä¸Šç”¨ Docker æ¥æ„å»ºã€å¼€å‘å’Œè°ƒè¯•ã€‚ä¸‹é¢æˆ‘ç»™ä½ ä¸€ä¸ªåˆ†å±‚ã€å¯æ“ä½œçš„æ–¹æ¡ˆï¼š

---

ğŸ§© æ¶æ„æ€è·¯

â€¢ Web å‰ç«¯ï¼šç‹¬ç«‹å®¹å™¨ï¼ˆä¾‹å¦‚ React/Vue/Angularï¼‰ï¼Œé€šè¿‡ Nginx æˆ–ç›´æ¥ Node.js æœåŠ¡ã€‚
â€¢ API åç«¯ï¼šSpring Boot (Kotlin)ï¼Œæ‰“åŒ…æˆ Docker é•œåƒï¼Œæš´éœ² REST/gRPC APIã€‚
â€¢ æ•°æ®åº“ï¼šPostgreSQL å®¹å™¨ï¼ŒæŒ‚è½½æœ¬åœ°å·ä¿å­˜æ•°æ®ã€‚
â€¢ å¼€å‘è°ƒè¯•ï¼šä½¿ç”¨ docker-compose ç®¡ç†å¤šå®¹å™¨ï¼Œæ”¯æŒçƒ­åŠ è½½å’Œæœ¬åœ°è°ƒè¯•ã€‚


---

ğŸ§© 1. Dockerfile ç¤ºä¾‹

API æœåŠ¡ (Spring Boot + Kotlin)

# Dockerfile-api
FROM gradle:8.5-jdk17 AS build
WORKDIR /app
COPY . .
RUN gradle clean build -x test

FROM openjdk:17-jdk-slim
WORKDIR /app
COPY --from=build /app/build/libs/*.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java","-jar","app.jar"]


Web å‰ç«¯ (React/Vue)

# Dockerfile-web
FROM node:20 AS build
WORKDIR /app
COPY . .
RUN npm install && npm run build

FROM nginx:alpine
COPY --from=build /app/dist /usr/share/nginx/html
EXPOSE 80


---

ğŸ§© 2. docker-compose.yml

version: "3.9"
services:
  api:
    build:
      context: ./api
      dockerfile: Dockerfile-api
    ports:
      - "8080:8080"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://db:5432/mydb
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=postgres
    depends_on:
      - db

  web:
    build:
      context: ./web
      dockerfile: Dockerfile-web
    ports:
      - "3000:80"
    depends_on:
      - api

  db:
    image: postgres:15
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: mydb
    ports:
      - "5432:5432"
    volumes:
      - ./data:/var/lib/postgresql/data


---

ğŸ§© 3. å¼€å‘ä¸è°ƒè¯•ç­–ç•¥

â€¢ æœ¬åœ°å¼€å‘ï¼šâ€¢ APIï¼šåœ¨ Mac æœ¬åœ°è¿è¡Œ ./gradlew bootRunï¼Œè¿æ¥ Docker å†…çš„ Postgresã€‚
â€¢ Webï¼šåœ¨ Mac æœ¬åœ°è¿è¡Œ npm run devï¼Œè¿æ¥ API å®¹å™¨ã€‚

â€¢ å®¹å™¨è°ƒè¯•ï¼šâ€¢ ä½¿ç”¨ docker-compose up å¯åŠ¨æ‰€æœ‰æœåŠ¡ã€‚
â€¢ åœ¨ API å®¹å™¨ä¸­æŒ‚è½½æºç ç›®å½•ï¼Œç»“åˆ spring-boot-devtools å®ç°çƒ­åŠ è½½ã€‚
â€¢ PostgreSQL æŒ‚è½½æœ¬åœ°å·ï¼Œé¿å…æ•°æ®ä¸¢å¤±ã€‚

â€¢ è°ƒè¯•å·¥å…·ï¼šâ€¢ docker exec -it <container> bash è¿›å…¥å®¹å™¨ã€‚
â€¢ psql -h localhost -p 5432 -U postgres è¿æ¥æ•°æ®åº“ã€‚
â€¢ ä½¿ç”¨ grpcurl æˆ– curl æµ‹è¯• APIã€‚



---

ğŸ§© 4. è°ƒè¯•æµç¨‹ç¤ºä¾‹

1. å¯åŠ¨å®¹å™¨ï¼šdocker-compose up --build

2. æµ‹è¯• APIï¼šcurl http://localhost:8080/api/health
æˆ–è€… gRPCï¼šgrpcurl -plaintext localhost:8080 my.package.Service.Method

3. æµ‹è¯• Webï¼šopen http://localhost:3000



---

ğŸ§© 5. å»ºè®®çš„å¼€å‘æ¨¡å¼

â€¢ å¿«é€Ÿè¿­ä»£ï¼šæœ¬åœ°è¿è¡Œ Web/APIï¼Œæ•°æ®åº“ç”¨ Dockerã€‚
â€¢ é›†æˆæµ‹è¯•ï¼šå…¨éƒ¨è·‘åœ¨ Docker å†…ï¼Œæ¨¡æ‹Ÿç”Ÿäº§ç¯å¢ƒã€‚
â€¢ CI/CDï¼šGradle æ„å»º â†’ Docker é•œåƒ â†’ æ¨é€åˆ°ç§æœ‰ä»“åº“ â†’ éƒ¨ç½²ã€‚


---

ğŸ‘‰ æˆ‘å¯ä»¥å¸®ä½ ç”»ä¸€ä¸ª æ¶æ„æµç¨‹å›¾ (Web â†” API â†” DB in Docker)ï¼Œè®©ä½ æ›´ç›´è§‚åœ°çœ‹åˆ°å®¹å™¨ä¹‹é—´çš„å…³ç³»ã€‚è¦ä¸è¦æˆ‘ç»™ä½ ç”Ÿæˆä¸€ä¸ªå›¾è¡¨æ¥å±•ç¤ºè¿™ä¸ªæ¶æ„?


