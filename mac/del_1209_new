å¥½çš„ï¼ŒArronï¼Œæˆ‘æ¥ä¸ºä½ åˆ†å±‚æ¢³ç† Spring Boot + Gradle + Kotlin æ¶æ„ï¼Œå¹¶ç»“åˆ ç”¨æˆ·ç™»å½•ä¸ session ç®¡ç†çš„åœºæ™¯ï¼Œé€å±‚è¯´æ˜å¦‚ä½•ä¿®æ”¹å’Œæ‰©å±•åŠŸèƒ½ï¼Œç›´åˆ°æœ€ç»ˆæŠŠç™»å½•ä¿¡æ¯å†™å…¥æ•°æ®åº“è¡¨ã€‚

---

ğŸ— æ¶æ„åˆ†å±‚ä½œç”¨

Spring Boot + Kotlin å¸¸è§åˆ†å±‚ç»“æ„å¦‚ä¸‹ï¼š

å±‚çº§	ä½œç”¨	ç¤ºä¾‹	
Controller å±‚	æ¥æ”¶ HTTP è¯·æ±‚ï¼Œå¤„ç†å‚æ•°ï¼Œè°ƒç”¨ Service å±‚	LoginController	
Service å±‚	ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼Œè°ƒç”¨ Repository å±‚	LoginService	
Repository å±‚	æ•°æ®è®¿é—®å±‚ï¼Œæ“ä½œæ•°æ®åº“	UserRepository	
Entity/Model å±‚	æ•°æ®è¡¨æ˜ å°„ï¼Œå®šä¹‰å¯¹è±¡ç»“æ„	UserEntity	
Config å±‚	é…ç½®å®‰å…¨ç­–ç•¥ã€Session ç®¡ç†ã€æ‹¦æˆªå™¨ç­‰	SecurityConfig	


---

ğŸ”‘ ä¿®æ”¹è¿‡ç¨‹ï¼šåŸºäºç”¨æˆ·ç™»å½•ä¸ Session

ä¸‹é¢æˆ‘åˆ†æ­¥éª¤è¯´æ˜å¦‚ä½•é€å±‚ä¿®æ”¹ï¼š

1. Entity å±‚ï¼šå®šä¹‰ç”¨æˆ·è¡¨

â€¢ æ–°å»º UserEntity.kt æ˜ å°„æ•°æ®åº“è¡¨ users
â€¢ å­—æ®µåŒ…æ‹¬ï¼šid, username, password, sessionId, lastLoginTime


@Entity
@Table(name = "users")
data class UserEntity(
    @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
    val id: Long = 0,
    val username: String,
    val password: String,
    var sessionId: String? = null,
    var lastLoginTime: LocalDateTime? = null
)


---

2. Repository å±‚ï¼šæ“ä½œæ•°æ®åº“

â€¢ æ–°å»º UserRepository.ktï¼Œç»§æ‰¿ JpaRepository
â€¢ å¢åŠ æŸ¥è¯¢æ–¹æ³•ï¼šæ ¹æ®ç”¨æˆ·åæŸ¥æ‰¾ç”¨æˆ·


interface UserRepository : JpaRepository<UserEntity, Long> {
    fun findByUsername(username: String): UserEntity?
}


---

3. Service å±‚ï¼šä¸šåŠ¡é€»è¾‘

â€¢ æ–°å»º LoginService.kt
â€¢ åŠŸèƒ½ï¼šæ ¡éªŒç”¨æˆ·ã€ç”Ÿæˆ Sessionã€æ›´æ–°æ•°æ®åº“


@Service
class LoginService(val userRepository: UserRepository) {

    fun login(username: String, password: String): String? {
        val user = userRepository.findByUsername(username)
        if (user != null && user.password == password) {
            val sessionId = UUID.randomUUID().toString()
            user.sessionId = sessionId
            user.lastLoginTime = LocalDateTime.now()
            userRepository.save(user)
            return sessionId
        }
        return null
    }

    fun validateSession(sessionId: String): Boolean {
        return userRepository.findAll().any { it.sessionId == sessionId }
    }
}


---

4. Controller å±‚ï¼šå¤„ç†è¯·æ±‚

â€¢ æ–°å»º LoginController.kt
â€¢ æä¾› /login å’Œ /validate æ¥å£


@RestController
@RequestMapping("/auth")
class LoginController(val loginService: LoginService) {

    @PostMapping("/login")
    fun login(@RequestParam username: String, @RequestParam password: String): ResponseEntity<String> {
        val sessionId = loginService.login(username, password)
        return if (sessionId != null) ResponseEntity.ok(sessionId)
        else ResponseEntity.status(HttpStatus.UNAUTHORIZED).body("Login failed")
    }

    @GetMapping("/validate")
    fun validate(@RequestParam sessionId: String): ResponseEntity<String> {
        return if (loginService.validateSession(sessionId))
            ResponseEntity.ok("Session valid")
        else ResponseEntity.status(HttpStatus.UNAUTHORIZED).body("Invalid session")
    }
}


---

5. Config å±‚ï¼šå®‰å…¨ä¸ Session ç®¡ç†

â€¢ ä½¿ç”¨ Spring Security æˆ–è‡ªå®šä¹‰æ‹¦æˆªå™¨
â€¢ åœ¨ SecurityConfig.kt ä¸­é…ç½®å“ªäº›æ¥å£éœ€è¦ç™»å½•æ‰èƒ½è®¿é—®


@Configuration
@EnableWebSecurity
class SecurityConfig : WebSecurityConfigurerAdapter() {
    override fun configure(http: HttpSecurity) {
        http.csrf().disable()
            .authorizeRequests()
            .antMatchers("/auth/login").permitAll()
            .anyRequest().authenticated()
    }
}


---

ğŸ“ˆ ä¿®æ”¹è¿‡ç¨‹æ€»ç»“

1. Entity å±‚ï¼šå¢åŠ ç”¨æˆ·è¡¨å­—æ®µï¼ˆsessionIdã€lastLoginTimeï¼‰ã€‚
2. Repository å±‚ï¼šæä¾›æŸ¥è¯¢æ–¹æ³•ã€‚
3. Service å±‚ï¼šå®ç°ç™»å½•é€»è¾‘ï¼Œç”Ÿæˆå¹¶ä¿å­˜ Sessionã€‚
4. Controller å±‚ï¼šæä¾›æ¥å£ï¼Œè¿”å› Sessionã€‚
5. Config å±‚ï¼šé…ç½®å®‰å…¨ç­–ç•¥ï¼Œé™åˆ¶æœªç™»å½•ç”¨æˆ·è®¿é—®ã€‚


è¿™æ ·ï¼Œç”¨æˆ·ä» ç™»å½•è¯·æ±‚ â†’ Session æ ¡éªŒ â†’ æ•°æ®åº“æ›´æ–° å°±å½¢æˆäº†å®Œæ•´é“¾è·¯ã€‚

---

ğŸ‘‰ æˆ‘å¯ä»¥è¿›ä¸€æ­¥å¸®ä½ æŠŠè¿™ä¸ªæµç¨‹ç”»æˆä¸€ä¸ª Mermaid æµç¨‹å›¾ï¼Œè®©ä½ å¿«é€Ÿçœ‹åˆ°ä» Controller åˆ°æ•°æ®åº“çš„è°ƒç”¨é“¾ã€‚è¦ä¸è¦æˆ‘å¸®ä½ ç”»å‡ºæ¥ï¼Ÿ

